# Monetrix — инструкция для backend-разработчика

## 1. Общая архитектурная идея

- Фронтенд (Vite React SPA) ожидает REST/JSON API, доступный по базовому URL, который мы будем прокидывать через переменную окружения `VITE_API_BASE_URL`.
- Авторизация пользователей и предпринимателей строится вокруг OAuth 2.0 / OIDC с банками, но для начала достаточно мокового backend-а, который эмулирует процесс получения consent и возвращает нормализованные данные аккаунтов/транзакций.
- Все банковские данные приводим к единой схеме (`Account`, `Balance`, `Transaction`, `Product`), чтобы фронтенд мог одинаково работать с разными банками.

## 2. Эндпоинты, которые нужны фронтенду на первом этапе

```
POST   /api/auth/login                // вход пользователя; разные payload для ФЛ и ИП (см. ниже)
POST   /api/auth/register             // регистрация
POST   /api/auth/logout               // завершение сессии
GET    /api/auth/session              // проверить актуальность access token / refresh

GET    /api/profile                   // базовая информация о пользователе, роли, подключённых банках
POST   /api/consents                  // инициировать OAuth-подключение (возвращает redirect URL и state)
GET    /api/consents/:id/status       // статус согласия (pending/active/expired/revoked)
DELETE /api/consents/:id              // отзыв согласия

GET    /api/dashboard/summary         // агрегированные метрики (остатки, обязательства, цели)
GET    /api/dashboard/transactions    // список транзакций (пагинация, фильтры по дате/категории)
GET    /api/dashboard/budgets         // лимиты категорий и фактические траты
GET    /api/recommendations           // персональные рекомендации / уведомления

POST   /api/reports/export            // формирование отчётов (PDF, Мой Офис) — можно пока заглушку
```

## 3. Форматы запросов/ответов (минимально необходимое)

### 3.1. Авторизация

`POST /api/auth/login`

```
// вариант для физлица
{
  "userType": "individual",
  "email": "name@email.ru",
  "password": "***"
}

// вариант для предпринимателя / ИП
{
  "userType": "business",
  "organization": "ООО \"Монетрикс\"",
  "email": "founder@company.ru",
  "password": "***"
}

// ответ
{
  "accessToken": "jwt",
  "refreshToken": "jwt",
  "expiresIn": 3600,
  "user": {
    "id": "uuid",
    "userType": "individual",
    "fullName": "Иван Иванов"
  }
}
```

`POST /api/auth/register`

- Для `individual`: `fullName`, `email`, `password`.
- Для `business`: `companyName`, `inn`, `contact`, `email`, `password`.
- Ответ аналогичен логину.

### 3.2. Профиль и согласия

`GET /api/profile`

```
{
  "user": {
    "id": "uuid",
    "userType": "business",
    "fullName": "Иван Иванов",
    "companyName": "ООО \"Монетрикс\""
  },
  "consents": [
    {
      "id": "consent-id",
      "bank": "СБЕР",
      "status": "active",
      "expiresAt": "2025-12-01T00:00:00Z"
    }
  ]
}
```

`POST /api/consents`

```
{
  "bankCode": "sber"
}

// ответ
{
  "consentId": "consent-id",
  "authUrl": "https://sandbox.bank/auth?...",
  "state": "uuid"
}
```

### 3.3. Данные для дашборда

`GET /api/dashboard/summary`

```
{
  "netWorth": 1240500,
  "assets": 1980800,
  "liabilities": 740300,
  "cashflow": {
    "next30days": 135000,
    "trend": 0.18
  },
  "budgets": [
    { "category": "Развлечения", "limit": 20000, "actual": 21600 },
    { "category": "Финансовые услуги", "limit": 45000, "actual": 37000 }
  ]
}
```

`GET /api/dashboard/transactions`

фильтры: `?from=2025-10-01&to=2025-10-31&accountId=...&limit=50&offset=0`

```
{
  "items": [
    {
      "id": "tx-1",
      "accountId": "acc-1",
      "date": "2025-10-24",
      "description": "Покупка в магазине",
      "amount": -2800,
      "currency": "RUB",
      "category": "Развлечения",
      "counterparty": "OZON"
    }
  ],
  "pagination": { "limit": 50, "offset": 0, "total": 128 }
}
```

`GET /api/recommendations`

```
[
  {
    "id": "alert-1",
    "type": "budget",
    "title": "Превышение лимита",
    "message": "Раздел \"Развлечения\" превышен на 8%",
    "severity": "warning"
  },
  {
    "id": "offer-1",
    "type": "offer",
    "title": "Вклад 14,2%",
    "message": "Доступен вклад с налоговым вычетом",
    "cta": {
      "label": "Открыть оффер",
      "url": "https://partner.bank/offers/abc"
    }
  }
]
```

## 4. OAuth 2.0 / ГОСТ-шлюз — ожидания фронтенда

1. Фронт вызывает `POST /api/consents`, получает `authUrl`, открывает его в новом окне/redirect.
2. После успешного завершения банковского флоу backend получает `code`, обменивает на `access/refresh`, сохраняет в защищённом хранилище, нормализует данные.
3. Фронт опрашивает `GET /api/consents/:id/status` каждые 2–5 секунд, пока статус не станет `active` или `failed`.
4. Дальше выполняем выгрузку балансов/транзакций и пробрасываем в ответы выше.

## 5. Безопасность и инфраструктура

- TLS 1.2+ (при работе через ГОСТ — поддержка российских криптоалгоритмов).
- Шифрование refresh-токенов (можно начать с KMS/Hashicorp Vault или файлового HSM в песочнице).
- Аудит: логировать авторизации, выдачу и отзыв согласий, генерацию отчётов.
- Rate limiting и защита от повторной отправки (idempotency key в `POST`-запросах).
- Продумать CORS: разрешить домен фронта + локальную разработку (`http://localhost:5173`).

## 6. Переменные окружения (предложение)

```
API_PORT=8080
API_BASE_URL=https://api.monetrix.dev
FRONTEND_URL=http://localhost:5173
JWT_SECRET=...
REFRESH_TOKEN_TTL=30d
OAUTH_GOST_GATEWAY_URL=https://sandbox.gost-gateway.ru
OAUTH_CLIENT_ID=...
OAUTH_CLIENT_SECRET=...
DB_URL=postgres://user:pass@host:5432/monetrix
QUEUE_URL=... // например, Kafka / RabbitMQ для асинхронных обновлений
```

## 7. Совместная работа

1. После готовности API пропиши `VITE_API_BASE_URL` в `.env.local` фронтенда и передай мне формат ответов, если что-то меняется.
2. Определи статусы ошибок (например, `error.code`, `error.message`), чтобы я мог показывать UX-сообщения.
3. Предоставь моковые данные для работы без реального банка (JSON-файлы или dev-эндпоинт `GET /api/dev/bootstrap`).
4. Если появятся WebSocket / SSE для уведомлений — договоримся о формате канала (`/ws/notifications`).

## 8. Дополнительные материалы

- Стандарт ЦБ по открытым API (08.07.2021) — см. разделы 5–7 для требований к endpoint-ам и ошибкам.
- Стандарты безопасности Open API (9907, 9908) — определить необходимые меры защиты, журналирование, требования к хранению токенов.
- Финтех стратегии 2025–2027 — ориентир для масштабирования, локализации и партнёрских программ.

Если нужна дополнительная верстка под специфические ответы API, дай знать заранее — адаптирую UI.

